<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orbital Catering CRM</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBXczOmluY96FcE0PXBndJinIbLvXk91RY&callback=initMap"></script>
</head>
<body>
    <div class="background-pattern"></div>
    
    <div class="container">
        <div class="header">
            <h1>üöÄ ORBITAL CATERING CRM</h1>
        </div>

        <!-- Setup Section -->
        <div class="setup-section hidden" id="setupSection">
            <div class="loading" id="loadingDiv">
                <div class="loading-spinner"></div>
                <p>Connecting to Orbital Systems...</p>
            </div>
            <div id="connectionStatus" class="hidden"></div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation" id="tabNavigation">
            <button class="tab-btn active" onclick="showTab('todaysOrders')">üìÖ Today's Orders</button>
            <button class="tab-btn" onclick="showTab('orderHistory')">üìã All Orders</button>
            <button class="tab-btn" onclick="showTab('analytics')">üìä Analytics</button>
            <button class="tab-btn" onclick="showTab('salesPipeline')">üéØ Sales Pipeline</button>
            <button class="tab-btn" onclick="showTab('map')">üó∫Ô∏è Map</button>
        </div>

        <!-- Today's Orders Tab -->
        <div class="tab-content active" id="todaysOrdersTab">
            <h2>üìÖ Today's Orders</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="todayOrdersCount">0</div>
                    <div class="stat-label">Today's Orders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todayCustomersCount">0</div>
                    <div class="stat-label">Unique Companies</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todayGuestsCount">0</div>
                    <div class="stat-label">Total Headcount</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todayTier1Count">0</div>
                    <div class="stat-label">Tier 1 Customers</div>
                </div>
            </div>

            <div class="search-filter">
                <input type="text" id="todaySearchInput" placeholder="Search orders..." onkeyup="filterTodayOrders()">
                <select id="todayPlatformFilter" onchange="filterTodayOrders()">
                    <option value="">All Platforms</option>
                </select>
                <button class="btn btn-success" onclick="refreshData()">üîÑ Refresh</button>
            </div>

            <div style="overflow-x: auto;">
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th style="width: 30px;"></th>
                            <th>Time</th>
                            <th>Brand</th>
                            <th>Company</th>
                            <th>Address</th>
                            <th>Platform</th>
                            <th>Headcount</th>
                            <th>Contact</th>
                            <th>Phone</th>
                            <th>Status</th>
                            <th>Tier</th>
                            <th>Last Contact</th>
                        </tr>
                    </thead>
                    <tbody id="todayOrdersTable">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Order History Tab -->
        <div class="tab-content" id="orderHistoryTab">
            <h2>üìã All Orders</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalOrdersCount">0</div>
                    <div class="stat-label">Total Orders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="uniqueCompaniesCount">0</div>
                    <div class="stat-label">Unique Companies</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgOrderSize">0</div>
                    <div class="stat-label">Avg Headcount</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="tier1CustomersCount">0</div>
                    <div class="stat-label">Tier 1 Customers</div>
                </div>
            </div>

            <div class="search-filter">
                <input type="text" id="historySearchInput" placeholder="Search all orders..." onkeyup="filterHistoryOrders()">
                <select id="historyPlatformFilter" onchange="filterHistoryOrders()">
                    <option value="">All Platforms</option>
                </select>
                <select id="historyTierFilter" onchange="filterHistoryOrders()">
                    <option value="">All Tiers</option>
                    <option value="1">Tier 1</option>
                    <option value="2">Tier 2</option>
                    <option value="3">Tier 3</option>
                </select>
                <input type="date" id="startDateFilter" onchange="filterHistoryOrders()">
                <input type="date" id="endDateFilter" onchange="filterHistoryOrders()">
            </div>

            <div style="overflow-x: auto;">
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th style="width: 30px;"></th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Brand</th>
                            <th>Company</th>
                            <th>Address</th>
                            <th>Contact</th>
                            <th>Phone</th>
                            <th>Platform</th>
                            <th>Headcount</th>
                            <th>Requests</th>
                            <th>Driver</th>
                            <th>Tier</th>
                        </tr>
                    </thead>
                    <tbody id="historyOrdersTable">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div class="tab-content" id="analyticsTab">
            <h2>üìä Analytics Dashboard</h2>
            
            <div class="date-filters">
                <label>Date Range:</label>
                <input type="date" id="analyticsStartDate" onchange="updateAnalytics()">
                <label>to</label>
                <input type="date" id="analyticsEndDate" onchange="updateAnalytics()">
                <button class="btn btn-secondary" onclick="setDateRange('30days')">Last 30 Days</button>
                <button class="btn btn-secondary" onclick="setDateRange('90days')">Last 90 Days</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="analyticsTopPlatform">-</div>
                    <div class="stat-label">Top Platform</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="analyticsAvgHeadcount">0</div>
                    <div class="stat-label">Avg Headcount</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="analyticsMonthlyOrders">0</div>
                    <div class="stat-label">Total Orders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="analyticsRepeatCustomers">0</div>
                    <div class="stat-label">Repeat Customers</div>
                </div>
            </div>
            
            <div class="chart-grid">
                <div class="chart-container">
                    <h3>Orders by Platform</h3>
                    <canvas id="platformChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Orders Over Time</h3>
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>

            <div class="top-customers">
                <h3>Top Customers</h3>
                <div class="customer-list" id="topCustomersList">
                </div>
            </div>
        </div>

        <!-- Sales Pipeline Tab -->
        <div class="tab-content" id="salesPipelineTab">
            <h2>üéØ Sales Pipeline</h2>

            <div style="background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 20px; margin-bottom: 30px;">
                <h4 style="color: #7877c6; margin-bottom: 15px;">Tier Scoring Criteria</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; font-size: 0.9rem; color: rgba(255, 255, 255, 0.8);">
                    <div>
                        <strong>ü•á Tier 1:</strong> High-value prospects
                        <br>‚Ä¢ 5+ orders OR 3-4 orders + high headcount
                        <br>‚Ä¢ 50+ average guests preferred
                        <br>‚Ä¢ Multiple brands used
                    </div>
                    <div>
                        <strong>ü•à Tier 2:</strong> Medium potential
                        <br>‚Ä¢ 2-4 orders with decent volume
                        <br>‚Ä¢ 20-50 average guests
                        <br>‚Ä¢ Some brand diversity
                    </div>
                    <div>
                        <strong>ü•â Tier 3:</strong> Lower priority
                        <br>‚Ä¢ Few orders or small volume
                        <br>‚Ä¢ <20 average guests
                        <br>‚Ä¢ Limited engagement
                    </div>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="tier1ProspectsCount">0</div>
                    <div class="stat-label">Tier 1 Prospects</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="overdueFollowupsCount">0</div>
                    <div class="stat-label">Overdue Follow-ups</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="thisWeekFollowupsCount">0</div>
                    <div class="stat-label">This Week's Follow-ups</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="conversionRate">0%</div>
                    <div class="stat-label">Conversion Rate</div>
                </div>
            </div>

            <div class="search-filter two-row">
                <div class="search-row">
                    <input type="text" id="pipelineSearchInput" placeholder="Search companies..." onkeyup="filterPipelineCustomers()">
                    <input type="date" id="pipelineStartDate" onchange="filterPipelineCustomers()">
                    <input type="date" id="pipelineEndDate" onchange="filterPipelineCustomers()">
                </div>
                <div class="search-row">
                    <select id="pipelineTierFilter" onchange="filterPipelineCustomers()">
                        <option value="">All Tiers</option>
                        <option value="1">Tier 1</option>
                        <option value="2">Tier 2</option>
                        <option value="3">Tier 3</option>
                    </select>
                    <select id="pipelineStatusFilter" onchange="filterPipelineCustomers()">
                        <option value="">All Status</option>
                        <option value="prospect">Prospect</option>
                        <option value="contacted">Contacted</option>
                        <option value="converting">Converting</option>
                        <option value="converted">Converted to Direct</option>
                    </select>
                    <select id="pipelineFollowupFilter" onchange="filterPipelineCustomers()">
                        <option value="">All Follow-ups</option>
                        <option value="overdue">Overdue</option>
                        <option value="today">Due Today</option>
                        <option value="thisweek">This Week</option>
                    </select>
                </div>
            </div>

            <div style="overflow-x: auto;">
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th style="width: 30px;"></th>
                            <th>Company</th>
                            <th>Tier</th>
                            <th>Total Orders</th>
                            <th>Brand Diversity</th>
                            <th>Avg Headcount</th>
                            <th>Last Contact</th>
                            <th>Next Follow-up</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="pipelineTable">
                    </tbody>
                </table>
            </div>

            <div class="top-customers">
                <h3>Follow-up Queue</h3>
                <div id="followupQueue">
                    <div class="customer-item" style="background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3);">
                        <div style="display: flex; align-items: center; width: 100%;">
                            <span style="color: #f87171; font-weight: 600; margin-right: 15px;">üìÖ Today's Overdue</span>
                            <div id="todayOverdueList" style="flex: 1; color: rgba(255, 255, 255, 0.8);"></div>
                        </div>
                    </div>
                    <div class="customer-item" style="background: rgba(251, 191, 36, 0.1); border-color: rgba(251, 191, 36, 0.3);">
                        <div style="display: flex; align-items: center; width: 100%;">
                            <span style="color: #fbbf24; font-weight: 600; margin-right: 15px;">üìã Due Today</span>
                            <div id="todayDueList" style="flex: 1; color: rgba(255, 255, 255, 0.8);"></div>
                        </div>
                    </div>
                    <div class="customer-item" style="background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.3);">
                        <div style="display: flex; align-items: center; width: 100%;">
                            <span style="color: #34d399; font-weight: 600; margin-right: 15px;">üìÖ This Week</span>
                            <div id="thisWeekList" style="flex: 1; color: rgba(255, 255, 255, 0.8);"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map Tab -->
        <div class="tab-content" id="mapTab">
            <h2>üó∫Ô∏è Delivery Map</h2>
            
            <div class="date-filters">
                <button class="btn btn-secondary" onclick="showTodaysOrdersOnMap()">üìÖ Today's Orders</button>
                <label>Date Range:</label>
                <input type="date" id="mapStartDate" onchange="updateMap()">
                <label>to</label>
                <input type="date" id="mapEndDate" onchange="updateMap()">
                <button class="btn btn-secondary" onclick="setMapDateRange('7days')">Last 7 Days</button>
                <button class="btn btn-secondary" onclick="setMapDateRange('30days')">Last 30 Days</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="mapOrdersCount">0</div>
                    <div class="stat-label">Orders Plotted</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="mapUniqueAddresses">0</div>
                    <div class="stat-label">Unique Addresses</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="mapPickupsCount">0</div>
                    <div class="stat-label">Pickups</div>
                </div>
            </div>

            <div class="chart-container">
                <div id="map" style="height: 600px; border-radius: 12px; overflow: hidden;"></div>
            </div>
        </div>
    </div>

    <!-- Modal for Adding Notes/Follow-ups -->
    <div id="interactionModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeInteractionModal()">&times;</span>
            <h2 id="modalTitle">Add Customer Interaction</h2>
            
            <form id="interactionForm">
                <input type="hidden" id="modalCompany" value="">
                
                <div class="form-group">
                    <label for="interactionType">Interaction Type</label>
                    <select id="interactionType" required>
                        <option value="">Select Type</option>
                        <option value="email">Email</option>
                        <option value="phone">Phone Call</option>
                        <option value="meeting">In-Person Meeting</option>
                        <option value="proposal">Proposal Sent</option>
                        <option value="follow-up">Follow-up</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="interactionDate">Date</label>
                    <input type="date" id="interactionDate" required>
                </div>

                <div class="form-group">
                    <label for="interactionNotes">Notes</label>
                    <textarea id="interactionNotes" placeholder="Enter details about this interaction..." required></textarea>
                </div>

                <div class="form-group">
                    <label for="nextFollowupDate">Next Follow-up Date (Optional)</label>
                    <input type="date" id="nextFollowupDate">
                </div>

                <div class="form-group">
                    <label for="salesStatus">Sales Status</label>
                    <select id="salesStatus">
                        <option value="prospect">Prospect</option>
                        <option value="contacted">Contacted</option>
                        <option value="converting">Converting</option>
                        <option value="converted">Converted to Direct</option>
                    </select>
                </div>

                <div style="margin-top: 30px;">
                    <button type="submit" class="btn">Save Interaction</button>
                    <button type="button" class="btn btn-secondary" onclick="closeInteractionModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Load JavaScript modules -->
    <script src="js/config.js"></script>
    <script src="js/data-processing.js"></script>
    <script src="js/ui-components.js"></script>
    <script src="js/tabs/todays-orders.js"></script>
    <script src="js/tabs/order-history.js"></script>
    <script src="js/tabs/analytics.js"></script>
    <script src="js/tabs/sales-pipeline.js"></script>
    <script src="js/tabs/map.js"></script>
    <script src="js/interactions.js"></script>
    <script src="js/main.js"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orbital Catering CRM</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBXczOmluY96FcE0PXBndJinIbLvXk91RY&callback=initMap"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            min-height: 100vh;
            color: #ffffff;
            overflow-x: hidden;
        }

        .background-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 119, 198, 0.05) 0%, transparent 50%);
            z-index: -1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .header {
            background: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 40px;
            margin-bottom: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        }

        .header h1 {
            background: linear-gradient(135deg, #ffffff 0%, #7877c6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 3rem;
            margin-bottom: 10px;
            font-weight: 800;
            letter-spacing: -2px;
        }

        .header p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.2rem;
            font-weight: 300;
        }

        .setup-section {
            background: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 40px;
            margin-bottom: 30px;
        }

        .btn {
            background: linear-gradient(135deg, #7877c6 0%, #a855f7 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
            transition: all 0.3s ease;
            margin-right: 15px;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(120, 119, 198, 0.4);
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        }

        .tab-navigation {
            background: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            gap: 15px;
            position: relative;
        }

        .tab-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            padding: 16px 32px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #7877c6 0%, #a855f7 100%);
            color: white;
            border-color: #7877c6;
        }

        .tab-content {
            background: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 40px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .tab-content h2 {
            color: #ffffff;
            font-size: 2.2rem;
            margin-bottom: 30px;
            font-weight: 700;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(120, 119, 198, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #ffffff 0%, #7877c6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
        }

        .search-filter {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .search-filter.two-row {
            flex-direction: column;
            gap: 15px;
        }

        .search-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .search-filter input, .search-filter select {
            flex: 1;
            min-width: 200px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
            font-family: 'Montserrat', sans-serif;
            transition: all 0.3s ease;
        }

        .search-filter input:focus, .search-filter select:focus {
            outline: none;
            border-color: #7877c6;
            background: rgba(120, 119, 198, 0.1);
        }

        .search-filter select option {
            background: #1a1a1a;
            color: #ffffff;
            padding: 10px;
        }
        
        .orders-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .orders-table th, .orders-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .orders-table th {
            background: rgba(255, 255, 255, 0.05);
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .orders-table tbody tr {
            transition: all 0.3s ease;
        }

        .orders-table tbody tr:hover {
            background: rgba(120, 119, 198, 0.1);
        }

        .orders-table td {
            color: rgba(255, 255, 255, 0.8);
            font-weight: 400;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-completed { background: linear-gradient(135deg, #10b981, #34d399); color: white; }
        .status-pending { background: linear-gradient(135deg, #f59e0b, #fbbf24); color: white; }
        .status-needupdate { background: linear-gradient(135deg, #ef4444, #f87171); color: white; }

        .platform-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .platform-catercow { background: linear-gradient(135deg, #10b981, #34d399); color: white; }
        .platform-clubfeast { background: linear-gradient(135deg, #f59e0b, #fbbf24); color: white; }
        .platform-fooda { background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white; }
        .platform-sharebite { background: linear-gradient(135deg, #8b5cf6, #a78bfa); color: white; }
        .platform-ezcater { background: linear-gradient(135deg, #ef4444, #f87171); color: white; }
        .platform-direct { background: linear-gradient(135deg, #6b7280, #9ca3af); color: white; }

        .chart-container {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            position: relative;
        }

        .chart-container h3 {
            color: #ffffff;
            margin-bottom: 25px;
            font-weight: 600;
            font-size: 1.3rem;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .date-filters {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            align-items: center;
        }

        .date-filters label {
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            margin-right: 10px;
        }

        .hidden { display: none; }

        .loading {
            text-align: center;
            padding: 60px;
            color: rgba(255, 255, 255, 0.7);
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #7877c6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 30px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .connection-status, .error-status {
            padding: 20px;
            margin: 20px 0;
            border-radius: 12px;
            border-left: 4px solid;
        }

        .connection-status {
            background: rgba(16, 185, 129, 0.1);
            border-left-color: #10b981;
            color: #34d399;
        }

        .error-status {
            background: rgba(239, 68, 68, 0.1);
            border-left-color: #ef4444;
            color: #f87171;
        }

        .top-customers {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .top-customers h3 {
            margin-bottom: 25px;
        }

        .customer-list {
            display: grid;
            gap: 15px;
        }

        .customer-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .customer-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .customer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .customer-toggle {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem;
            margin-left: 10px;
            transition: transform 0.3s ease;
        }

        .customer-toggle.expanded {
            transform: rotate(180deg);
        }

        .customer-orders-detail {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            margin-top: 0;
        }

        .customer-orders-detail.expanded {
            max-height: 400px;
            margin-top: 15px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .order-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 15px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid rgba(120, 119, 198, 0.5);
        }

        .order-detail {
            display: flex;
            flex-direction: column;
        }

        .order-detail-label {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 3px;
        }

        .order-detail-value {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }

        .customer-name {
            font-weight: 600;
            color: #ffffff;
        }

        .customer-orders {
            color: #7877c6;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
            
            .tab-navigation {
                flex-direction: column;
            }
            
            .search-filter {
                flex-direction: column;
            }
            
            .orders-table {
                font-size: 0.85rem;
            }

            .header h1 {
                font-size: 2.2rem;
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #7877c6, #a855f7);
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="background-pattern"></div>
    
    <div class="container">
        <div class="header">
            <h1>üöÄ ORBITAL CATERING CRM</h1>
        </div>

        <div class="setup-section hidden" id="setupSection">
            <div class="loading" id="loadingDiv">
                <div class="loading-spinner"></div>
                <p>Connecting to Orbital Systems...</p>
            </div>
            <div id="connectionStatus" class="hidden"></div>
        </div>

        <div class="tab-navigation" id="tabNavigation">
            <button class="tab-btn active" onclick="showTab('todaysOrders')">üìÖ Today's Orders</button>
            <button class="tab-btn" onclick="showTab('orderHistory')">üìã All Orders</button>
            <button class="tab-btn" onclick="showTab('analytics')">üìä Analytics</button>
            <button class="tab-btn" onclick="showTab('map')">üó∫Ô∏è Map</button>
        </div>

        <!-- Today's Orders Tab -->
        <div class="tab-content active" id="todaysOrdersTab">
            <h2>üìÖ Today's Orders</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="todayOrdersCount">0</div>
                    <div class="stat-label">Today's Orders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todayCustomersCount">0</div>
                    <div class="stat-label">Unique Companies</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todayGuestsCount">0</div>
                    <div class="stat-label">Total Headcount</div>
                </div>
            </div>

            <div class="search-filter">
                <input type="text" id="todaySearchInput" placeholder="Search orders..." onkeyup="filterTodayOrders()">
                <select id="todayPlatformFilter" onchange="filterTodayOrders()">
                    <option value="">All Platforms</option>
                </select>
                <button class="btn btn-success" onclick="refreshData()">üîÑ Refresh</button>
            </div>

            <div style="overflow-x: auto;">
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Brand</th>
                            <th>Company</th>
                            <th>Address</th>
                            <th>Platform</th>
                            <th>Headcount</th>
                            <th>Contact</th>
                            <th>Phone</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="todayOrdersTable">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- All Orders Tab -->
        <div class="tab-content" id="orderHistoryTab">
            <h2>üìã All Orders</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalOrdersCount">0</div>
                    <div class="stat-label">Total Orders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="uniqueCompaniesCount">0</div>
                    <div class="stat-label">Unique Companies</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgOrderSize">0</div>
                    <div class="stat-label">Avg Headcount</div>
                </div>
            </div>

            <div class="search-filter two-row">
                <div class="search-row">
                    <input type="text" id="historySearchInput" placeholder="Search all orders..." onkeyup="filterHistoryOrders()">
                </div>
                <div class="search-row">
                    <input type="text" id="historyCompanyFilter" placeholder="Filter by company..." onkeyup="filterHistoryOrders()">
                    <input type="text" id="historyBrandFilter" placeholder="Filter by brand..." onkeyup="filterHistoryOrders()">
                    <select id="historyPlatformFilter" onchange="filterHistoryOrders()">
                        <option value="">All Platforms</option>
                    </select>
                    <input type="date" id="startDateFilter" onchange="filterHistoryOrders()">
                    <input type="date" id="endDateFilter" onchange="filterHistoryOrders()">
                </div>
            </div>

            <div style="overflow-x: auto;">
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Brand</th>
                            <th>Company</th>
                            <th>Address</th>
                            <th>Contact</th>
                            <th>Phone</th>
                            <th>Platform</th>
                            <th>Headcount</th>
                            <th>Requests</th>
                            <th>Driver</th>
                        </tr>
                    </thead>
                    <tbody id="historyOrdersTable">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div class="tab-content" id="analyticsTab">
            <h2>üìä Analytics Dashboard</h2>
            
            <div class="date-filters">
                <label>Date Range:</label>
                <input type="date" id="analyticsStartDate" onchange="updateAnalytics()">
                <label>to</label>
                <input type="date" id="analyticsEndDate" onchange="updateAnalytics()">
                <button class="btn btn-secondary" onclick="setDateRange('30days')">Last 30 Days</button>
                <button class="btn btn-secondary" onclick="setDateRange('90days')">Last 90 Days</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="analyticsTopPlatform">-</div>
                    <div class="stat-label">Top Platform</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="analyticsAvgHeadcount">0</div>
                    <div class="stat-label">Avg Headcount</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="analyticsMonthlyOrders">0</div>
                    <div class="stat-label">Total Orders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="analyticsRepeatCustomers">0</div>
                    <div class="stat-label">Repeat Customers</div>
                </div>
            </div>
            
            <div class="chart-grid">
                <div class="chart-container">
                    <h3>Orders by Platform</h3>
                    <canvas id="platformChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Orders Over Time</h3>
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>

            <div class="top-customers">
                <h3>Top Customers</h3>
                <div class="customer-list" id="topCustomersList">
                </div>
            </div>
        </div>

        <!-- Map Tab -->
        <div class="tab-content" id="mapTab">
            <h2>üó∫Ô∏è Delivery Map</h2>
            
            <div class="date-filters">
                <button class="btn btn-secondary" onclick="showTodaysOrdersOnMap()">üìÖ Today's Orders</button>
                <label>Date Range:</label>
                <input type="date" id="mapStartDate" onchange="updateMap()">
                <label>to</label>
                <input type="date" id="mapEndDate" onchange="updateMap()">
                <button class="btn btn-secondary" onclick="setMapDateRange('7days')">Last 7 Days</button>
                <button class="btn btn-secondary" onclick="setMapDateRange('30days')">Last 30 Days</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="mapOrdersCount">0</div>
                    <div class="stat-label">Orders Plotted</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="mapUniqueAddresses">0</div>
                    <div class="stat-label">Unique Addresses</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="mapPickupsCount">0</div>
                    <div class="stat-label">Pickups</div>
                </div>
            </div>

            <div class="chart-container">
                <div id="map" style="height: 600px; border-radius: 12px; overflow: hidden;"></div>
            </div>
        </div>
    </div>

    <script>
        const SHEET_ID = '1dms10f1dUDnzVXwLzTYXRzgDXmGLeAq7VmYIUy-jE8M';
        
        let allOrders = [];
        let connectionConfig = {};
        let charts = {};
        let map;
        let markers = [];
        let geocodeCache = {};

        // Auto-connect on page load
        const AUTO_API_KEY = 'AIzaSyBXczOmluY96FcE0PXBndJinIbLvXk91RY';
        const AUTO_ORBITAL_TAB = 'Orbital';

        connectionConfig = {
            method: 'apiKey',
            apiKey: AUTO_API_KEY,
            orbitalTab: AUTO_ORBITAL_TAB
        };

        async function autoConnect() {
            showLoading(true);
            
            try {
                await loadDataFromGoogleSheets();
                showStatus('‚úÖ Connected to Orbital Systems!', 'success');
                launchCRM();
            } catch (error) {
                showStatus('Connection failed: ' + error.message, 'error');
                showLoading(false);
            }
        }

        async function loadDataFromGoogleSheets() {
            const orbitalRange = `${connectionConfig.orbitalTab}!A:AC`;
            const orbitalUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${orbitalRange}?key=${connectionConfig.apiKey}`;
            
            const orbitalResponse = await fetch(orbitalUrl);
            const orbitalData = await orbitalResponse.json();
            
            if (orbitalData.error) {
                throw new Error(`Orbital data: ${orbitalData.error.message}`);
            }

            allOrders = processOrbitalData(orbitalData.values);
        }

        function processOrbitalData(rawData) {
            if (!rawData || rawData.length < 2) {
                return [];
            }

            const rows = rawData.slice(1);

            const processedOrders = rows.filter(row => {
                const dateStr = row[2];
                const canceled = row[6];
                
                if (canceled && canceled.toString().trim().toLowerCase() === 'y') {
                    return false;
                }
                
                return dateStr && typeof dateStr === 'string' && 
                       (dateStr.includes('2024') || dateStr.includes('2025') || 
                        dateStr.match(/\b(January|February|March|April|May|June|July|August|September|October|November|December|Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\b/i));
            }).map((row, index) => {
                const parsedDate = parseDate(row[2]);
                
                return {
                    id: index + 1,
                    date: parsedDate,
                    originalDate: row[2],
                    time: standardizeTime(row[4] || ''),
                    platform: standardizePlatform(row[3] || ''),
                    company: (row[8] || 'Unknown').trim(),
                    brand: (row[7] || '').trim(),
                    address: (row[9] || '').trim(),
                    guests: parseGuestCount(row[10]),
                    guestsRaw: (row[10] || '').toString().trim(),
                    contactPerson: (row[11] || '').trim(),
                    phoneNumber: (row[13] || '').trim(),
                    customerRequests: (row[18] || '').trim(),
                    driver: (row[22] || '').trim(),
                    productionStatus: (row[14] || '').trim()
                };
            }).filter(order => order.date && order.date !== '');

            return processedOrders.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        function parseDate(dateStr) {
            if (!dateStr) return '';
            
            try {
                const date = new Date(dateStr);
                if (!isNaN(date.getTime())) {
                    return date.toISOString().split('T')[0];
                }
            } catch (error) {
                console.error('Date parsing error for:', dateStr, error);
            }
            
            return '';
        }

        function parseGuestCount(guestStr) {
            if (!guestStr) return 0;
            
            const str = String(guestStr).trim();
            if (!str) return 0;
            
            const match = str.match(/^(\d+(?:\.\d+)?)/);
            
            if (match) {
                const number = parseFloat(match[1]);
                if (number > 1000) {
                    return 0;
                }
                return Math.round(number);
            }
            
            return 0;
        }

        function standardizeTime(timeStr) {
            if (!timeStr) return '';
            return timeStr.replace(/\s+/g, ' ')
                         .replace(/- /g, ' - ')
                         .replace(/AM/gi, 'AM')
                         .replace(/PM/gi, 'PM')
                         .trim();
        }

        function standardizePlatform(platform) {
            if (!platform) return 'Direct';
            
            const cleaned = platform.replace(/[\b]/g, '')
                                  .replace(/\s+/g, ' ')
                                  .trim()
                                  .toLowerCase();
            
            if (cleaned.includes('catercow')) return 'CaterCow';
            if (cleaned.includes('clubfeast')) return 'ClubFeast';
            if (cleaned.includes('fooda')) return 'Fooda';
            if (cleaned.includes('sharebite') || cleaned.includes('share bite')) return 'ShareBite';
            if (cleaned.includes('ezcater') || cleaned.includes('ez cater')) return 'ezCater';
            
            return platform.replace(/[\b]/g, '')
                          .replace(/\s+/g, ' ')
                          .trim()
                          .split(' ')
                          .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                          .join(' ');
        }

        function getStatusClass(status) {
            if (!status) return 'pending';
            
            const statusLower = status.toLowerCase();
            
            if (statusLower.includes('completed') || statusLower.includes('done') || statusLower === 'complete') {
                return 'completed';
            } else if (statusLower.includes('need') || statusLower.includes('update') || statusLower.includes('issue') || statusLower.includes('problem')) {
                return 'needupdate';
            } else {
                return 'pending';
            }
        }

        function getTodaysDate() {
            return new Date().toISOString().split('T')[0];
        }

        function showLoading(show) {
            document.getElementById('loadingDiv').classList.toggle('hidden', !show);
            document.getElementById('setupSection').classList.toggle('hidden', !show);
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.className = type === 'error' ? 'error-status' : 'connection-status';
            statusDiv.innerHTML = `<h4>${type === 'error' ? '‚ùå' : '‚úÖ'} ${type === 'error' ? 'Connection Error' : 'Connection Success'}</h4><p>${message}</p>`;
            statusDiv.classList.remove('hidden');
            
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, 3000);
            }
        }

        function launchCRM() {
            document.getElementById('setupSection').classList.add('hidden');
            
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById('todaysOrdersTab').classList.add('active');
            document.querySelector('button[onclick="showTab(\'todaysOrders\')"]').classList.add('active');
            
            updateAllData();
        }

        async function refreshData() {
            if (!connectionConfig.apiKey) return;
            
            showLoading(true);
            try {
                await loadDataFromGoogleSheets();
                updateAllData();
                showStatus('‚úÖ Data refreshed successfully!', 'success');
                setTimeout(() => {
                    document.getElementById('connectionStatus').classList.add('hidden');
                }, 3000);
            } catch (error) {
                showStatus('Refresh failed: ' + error.message, 'error');
            }
            showLoading(false);
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'todaysOrders') {
                updateTodaysOrders();
            } else if (tabName === 'orderHistory') {
                updateOrderHistory();
            } else if (tabName === 'analytics') {
                updateAnalytics();
            } else if (tabName === 'map') {
                updateMap();
            }
        }

        function updateAllData() {
            updateTodaysOrders();
            updateOrderHistory();
            updateAnalytics();
            
            if (document.getElementById('mapStartDate').value === '') {
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(endDate.getDate() - 7);
                
                document.getElementById('mapStartDate').value = startDate.toISOString().split('T')[0];
                document.getElementById('mapEndDate').value = endDate.toISOString().split('T')[0];
            }
            
            const platforms = [...new Set(allOrders.map(o => o.platform).filter(p => p))];
            
            const todayPlatformFilter = document.getElementById('todayPlatformFilter');
            const historyPlatformFilter = document.getElementById('historyPlatformFilter');
            
            [todayPlatformFilter, historyPlatformFilter].forEach(select => {
                select.innerHTML = '<option value="">All Platforms</option>';
                platforms.forEach(platform => {
                    const option = document.createElement('option');
                    option.value = platform;
                    option.textContent = platform;
                    select.appendChild(option);
                });
            });
        }

        function updateTodaysOrders() {
            const today = getTodaysDate();
            const todaysOrders = allOrders.filter(order => order.date === today);
            
            const totalGuests = todaysOrders.reduce((sum, o) => sum + o.guests, 0);
            const uniqueCompanies = new Set(todaysOrders.map(o => o.company)).size;
            
            document.getElementById('todayOrdersCount').textContent = todaysOrders.length;
            document.getElementById('todayCustomersCount').textContent = uniqueCompanies;
            document.getElementById('todayGuestsCount').textContent = totalGuests;
            
            renderTodayOrders();
        }

        function renderTodayOrders() {
            const today = getTodaysDate();
            const todaysOrders = allOrders.filter(order => order.date === today);
            
            const searchTerm = document.getElementById('todaySearchInput').value.toLowerCase();
            const platformFilter = document.getElementById('todayPlatformFilter').value;

            const filteredOrders = todaysOrders.filter(order => {
                const matchesSearch = order.company.toLowerCase().includes(searchTerm) || 
                                    order.contactPerson.toLowerCase().includes(searchTerm);
                const matchesPlatform = !platformFilter || order.platform === platformFilter;
                return matchesSearch && matchesPlatform;
            });

            const tableBody = document.getElementById('todayOrdersTable');
            
            if (filteredOrders.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.5);">
                            No orders found for today (${today})
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = filteredOrders.map(order => `
                <tr>
                    <td>${order.time}</td>
                    <td>${order.brand}</td>
                    <td>${order.company}</td>
                    <td>${order.address}</td>
                    <td><span class="platform-badge platform-${order.platform.toLowerCase().replace(/\s+/g, '')}">${order.platform}</span></td>
                    <td>${order.guestsRaw}</td>
                    <td>${order.contactPerson}</td>
                    <td>${order.phoneNumber}</td>
                    <td><span class="status-badge status-${getStatusClass(order.productionStatus)}">${order.productionStatus}</span></td>
                </tr>
            `).join('');
        }

        function updateOrderHistory() {
            const uniqueCompanies = new Set(allOrders.map(o => o.company)).size;
            const avgGuests = allOrders.length > 0 ? 
                allOrders.reduce((sum, o) => sum + o.guests, 0) / allOrders.length : 0;
            
            document.getElementById('totalOrdersCount').textContent = allOrders.length.toLocaleString();
            document.getElementById('uniqueCompaniesCount').textContent = uniqueCompanies;
            document.getElementById('avgOrderSize').textContent = Math.round(avgGuests);
            
            renderHistoryOrders();
        }

        function renderHistoryOrders() {
            const searchTerm = document.getElementById('historySearchInput').value.toLowerCase();
            const companyFilter = document.getElementById('historyCompanyFilter').value.toLowerCase();
            const brandFilter = document.getElementById('historyBrandFilter').value.toLowerCase();
            const platformFilter = document.getElementById('historyPlatformFilter').value;
            const startDate = document.getElementById('startDateFilter').value;
            const endDate = document.getElementById('endDateFilter').value;

            let filteredOrders = allOrders.filter(order => {
                const matchesSearch = order.company.toLowerCase().includes(searchTerm) ||
                                    order.contactPerson.toLowerCase().includes(searchTerm) ||
                                    order.brand.toLowerCase().includes(searchTerm);
                const matchesCompany = !companyFilter || order.company.toLowerCase().includes(companyFilter);
                const matchesBrand = !brandFilter || order.brand.toLowerCase().includes(brandFilter);
                const matchesPlatform = !platformFilter || order.platform === platformFilter;
                
                let matchesStartDate = true;
                let matchesEndDate = true;
                
                if (startDate && order.date) {
                    matchesStartDate = order.date >= startDate;
                }
                if (endDate && order.date) {
                    matchesEndDate = order.date <= endDate;
                }
                
                return matchesSearch && matchesCompany && matchesBrand && matchesPlatform && matchesStartDate && matchesEndDate;
            });

            filteredOrders = filteredOrders.slice(0, 500);

            const tableBody = document.getElementById('historyOrdersTable');
            
            if (filteredOrders.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.5);">
                            No orders found matching the current filters
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = filteredOrders.map(order => `
                <tr>
                    <td>${order.date}</td>
                    <td>${order.time}</td>
                    <td>${order.brand}</td>
                    <td>${order.company}</td>
                    <td>${order.address}</td>
                    <td>${order.contactPerson}</td>
                    <td>${order.phoneNumber}</td>
                    <td><span class="platform-badge platform-${order.platform.toLowerCase().replace(/\s+/g, '')}">${order.platform}</span></td>
                    <td>${order.guestsRaw}</td>
                    <td>${order.customerRequests}</td>
                    <td>${order.driver}</td>
                </tr>
            `).join('');
        }

        function updateAnalytics() {
            const startDate = document.getElementById('analyticsStartDate').value;
            const endDate = document.getElementById('analyticsEndDate').value;
            
            let analyticsOrders = allOrders.filter(order => {
                if (!order.company || order.company.toLowerCase() === 'unknown' || order.company.toLowerCase() === 'na') {
                    return false;
                }
                
                let matchesStartDate = true;
                let matchesEndDate = true;
                
                if (startDate && order.date) {
                    matchesStartDate = order.date >= startDate;
                }
                if (endDate && order.date) {
                    matchesEndDate = order.date <= endDate;
                }
                
                return matchesStartDate && matchesEndDate;
            });
            
            const platformData = {};
            analyticsOrders.forEach(order => {
                const platform = order.platform || 'Direct';
                if (platform.toLowerCase() !== 'na') {
                    platformData[platform] = (platformData[platform] || 0) + 1;
                }
            });

            const customerData = {};
            analyticsOrders.forEach(order => {
                customerData[order.company] = (customerData[order.company] || 0) + 1;
            });
            
            const topCustomers = Object.entries(customerData)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);

            const platformEntries = Object.entries(platformData);
            const topPlatform = platformEntries.length > 0 ? 
                platformEntries.reduce(([platA, countA], [platB, countB]) => 
                    countA > countB ? [platA, countA] : [platB, countB]
                )[0] : '-';
                
            const avgGuests = analyticsOrders.length > 0 ? 
                analyticsOrders.reduce((sum, o) => sum + o.guests, 0) / analyticsOrders.length : 0;
            
            const totalOrders = analyticsOrders.length;
            const repeatCustomers = Object.values(customerData).filter(count => count > 1).length;

            document.getElementById('analyticsTopPlatform').textContent = topPlatform;
            document.getElementById('analyticsAvgHeadcount').textContent = Math.round(avgGuests);
            document.getElementById('analyticsMonthlyOrders').textContent = totalOrders;
            document.getElementById('analyticsRepeatCustomers').textContent = repeatCustomers;

            const topCustomersList = document.getElementById('topCustomersList');
            if (topCustomers.length > 0) {
                topCustomersList.innerHTML = topCustomers.map(([company, count], index) => {
                    const customerOrders = analyticsOrders
                        .filter(order => order.company === company)
                        .sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    const ordersDetailHtml = customerOrders.map(order => `
                        <div class="order-item">
                            <div class="order-detail">
                                <div class="order-detail-label">Date</div>
                                <div class="order-detail-value">${order.date}</div>
                            </div>
                            <div class="order-detail">
                                <div class="order-detail-label">Brand</div>
                                <div class="order-detail-value">${order.brand || 'N/A'}</div>
                            </div>
                            <div class="order-detail">
                                <div class="order-detail-label">Platform</div>
                                <div class="order-detail-value">
                                    <span class="platform-badge platform-${order.platform.toLowerCase().replace(/\s+/g, '')}" style="font-size: 0.7rem; padding: 3px 8px;">
                                        ${order.platform}
                                    </span>
                                </div>
                            </div>
                            <div class="order-detail">
                                <div class="order-detail-label">Headcount</div>
                                <div class="order-detail-value">${order.guestsRaw} guests</div>
                            </div>
                        </div>
                    `).join('');

                    return `
                        <div>
                            <div class="customer-item" onclick="window.toggleCustomerOrders(${index})">
                                <div class="customer-header">
                                    <span class="customer-name">${company}</span>
                                    <div style="display: flex; align-items: center;">
                                        <span class="customer-orders">${count} orders</span>
                                        <span class="customer-toggle" id="toggle-${index}">‚ñº</span>
                                    </div>
                                </div>
                            </div>
                            <div class="customer-orders-detail" id="orders-${index}">
                                ${ordersDetailHtml}
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                topCustomersList.innerHTML = '<div style="text-align: center; color: rgba(255, 255, 255, 0.5);">No customer data available</div>';
            }

            createCharts(platformData, analyticsOrders);
        }

        function createCharts(platformData, ordersData) {
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });

            Chart.defaults.color = 'rgba(255, 255, 255, 0.8)';
            Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';

            const platformCtx = document.getElementById('platformChart').getContext('2d');
            const platforms = Object.keys(platformData);
            const counts = Object.values(platformData);
            const colors = [
                '#10b981', '#f59e0b', '#3b82f6', '#8b5cf6', '#ef4444', '#6b7280',
                '#ff6b35', '#00a86b', '#ff3008', '#009639', '#000000', '#7b68ee',
                '#ff1493', '#20b2aa', '#ff4500', '#4169e1'
            ];

            if (platforms.length > 0 && counts.some(count => count > 0)) {
                charts.platform = new Chart(platformCtx, {
                    type: 'doughnut',
                    data: {
                        labels: platforms,
                        datasets: [{
                            data: counts,
                            backgroundColor: colors.slice(0, platforms.length),
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    font: { family: 'Montserrat', size: 12 }
                                }
                            }
                        }
                    }
                });
            }

            const timelineData = {};
            ordersData.forEach(order => {
                if (order.date) {
                    timelineData[order.date] = (timelineData[order.date] || 0) + 1;
                }
            });

            const timelineCtx = document.getElementById('timelineChart').getContext('2d');
            
            if (Object.keys(timelineData).length > 0) {
                charts.timeline = new Chart(timelineCtx, {
                    type: 'line',
                    data: {
                        labels: Object.keys(timelineData).sort(),
                        datasets: [{
                            label: 'Orders',
                            data: Object.keys(timelineData).sort().map(date => timelineData[date]),
                            borderColor: '#7877c6',
                            backgroundColor: 'rgba(120, 119, 198, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            pointBackgroundColor: '#7877c6',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: { font: { family: 'Montserrat' } }
                            },
                            x: {
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: { font: { family: 'Montserrat' } }
                            }
                        },
                        plugins: {
                            legend: { labels: { font: { family: 'Montserrat' } } }
                        }
                    }
                });
            }
        }

        window.toggleCustomerOrders = function(index) {
            const ordersDetail = document.getElementById(`orders-${index}`);
            const toggle = document.getElementById(`toggle-${index}`);
            
            if (ordersDetail.classList.contains('expanded')) {
                ordersDetail.classList.remove('expanded');
                toggle.classList.remove('expanded');
            } else {
                document.querySelectorAll('.customer-orders-detail.expanded').forEach(detail => {
                    detail.classList.remove('expanded');
                });
                document.querySelectorAll('.customer-toggle.expanded').forEach(t => {
                    t.classList.remove('expanded');
                });
                
                ordersDetail.classList.add('expanded');
                toggle.classList.add('expanded');
            }
        };

        function setDateRange(range) {
            const endDate = new Date();
            const startDate = new Date();
            
            if (range === '30days') {
                startDate.setDate(endDate.getDate() - 30);
            } else if (range === '90days') {
                startDate.setDate(endDate.getDate() - 90);
            }
            
            document.getElementById('analyticsStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('analyticsEndDate').value = endDate.toISOString().split('T')[0];
            
            updateAnalytics();
        }

        function filterTodayOrders() {
            renderTodayOrders();
        }

        function filterHistoryOrders() {
            renderHistoryOrders();
        }

        // MAP FUNCTIONALITY
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 12,
                center: { lat: 40.7128, lng: -74.0060 },
                styles: [
                    {
                        elementType: "geometry",
                        stylers: [{ color: "#1a1a1a" }]
                    },
                    {
                        elementType: "labels.text.stroke",
                        stylers: [{ color: "#1a1a1a" }]
                    },
                    {
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#ffffff" }]
                    },
                    {
                        featureType: "administrative.locality",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#7877c6" }]
                    },
                    {
                        featureType: "poi",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#7877c6" }]
                    },
                    {
                        featureType: "poi.park",
                        elementType: "geometry",
                        stylers: [{ color: "#263c3f" }]
                    },
                    {
                        featureType: "poi.park",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#6b9a76" }]
                    },
                    {
                        featureType: "road",
                        elementType: "geometry",
                        stylers: [{ color: "#38414e" }]
                    },
                    {
                        featureType: "road",
                        elementType: "geometry.stroke",
                        stylers: [{ color: "#212a37" }]
                    },
                    {
                        featureType: "road",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#9ca5b3" }]
                    },
                    {
                        featureType: "road.highway",
                        elementType: "geometry",
                        stylers: [{ color: "#746855" }]
                    },
                    {
                        featureType: "road.highway",
                        elementType: "geometry.stroke",
                        stylers: [{ color: "#1f2835" }]
                    },
                    {
                        featureType: "road.highway",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#f3d19c" }]
                    },
                    {
                        featureType: "transit",
                        elementType: "geometry",
                        stylers: [{ color: "#2f3948" }]
                    },
                    {
                        featureType: "transit.station",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#7877c6" }]
                    },
                    {
                        featureType: "water",
                        elementType: "geometry",
                        stylers: [{ color: "#17263c" }]
                    },
                    {
                        featureType: "water",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#515c6d" }]
                    },
                    {
                        featureType: "water",
                        elementType: "labels.text.stroke",
                        stylers: [{ color: "#17263c" }]
                    }
                ]
            });

            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - 7);
            
            document.getElementById('mapStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('mapEndDate').value = endDate.toISOString().split('T')[0];
        }

        function cleanAddress(address) {
            if (!address) return '';
            
            if (address.toLowerCase().includes('pick up') || address.toLowerCase().trim() === 'pickup') {
                return '74 5th Ave, New York, NY, 10011';
            }
            
            let cleaned = address.trim();
            
            cleaned = cleaned.replace(/\s*\([^)]*\)\s*/g, ' ');
            cleaned = cleaned.replace(/\s*,\s*(room|floor|ste|suite|#)\s*[^,]*/gi, '');
            cleaned = cleaned.replace(/\s+(room|floor|ste|suite|#)\s+[^,\s]*/gi, '');
            cleaned = cleaned.replace(/\s*Cross Street:.*$/i, '');
            
            if (!cleaned.match(/New York,?\s*NY/i) && !cleaned.match(/NYC/i)) {
                if (!cleaned.match(/,\s*\d{5}$/)) {
                    cleaned += ', New York, NY';
                } else {
                    cleaned = cleaned.replace(/,\s*(\d{5})$/, ', New York, NY, $1');
                }
            }
            
            cleaned = cleaned.replace(/\s+/g, ' ');
            cleaned = cleaned.replace(/,\s*,/g, ',');
            cleaned = cleaned.replace(/^\s*,\s*|\s*,\s*$/g, '');
            
            return cleaned;
        }

        async function geocodeAddress(address) {
            if (geocodeCache[address]) {
                return geocodeCache[address];
            }
            
            const cleanedAddress = cleanAddress(address);
            if (!cleanedAddress) return null;
            
            if (geocodeCache[cleanedAddress]) {
                return geocodeCache[cleanedAddress];
            }
            
            try {
                const geocoder = new google.maps.Geocoder();
                const result = await new Promise((resolve, reject) => {
                    geocoder.geocode({ address: cleanedAddress }, (results, status) => {
                        if (status === 'OK' && results[0]) {
                            resolve(results[0]);
                        } else {
                            reject(new Error(`Geocoding failed: ${status}`));
                        }
                    });
                });
                
                const location = {
                    lat: result.geometry.location.lat(),
                    lng: result.geometry.location.lng(),
                    formattedAddress: result.formatted_address
                };
                
                geocodeCache[address] = location;
                geocodeCache[cleanedAddress] = location;
                return location;
            } catch (error) {
                console.warn('Failed to geocode address:', cleanedAddress, error);
                return null;
            }
        }

        function clearMarkers() {
            markers.forEach(marker => marker.setMap(null));
            markers = [];
        }

        async function updateMap() {
            if (!map) {
                console.warn('Map not initialized yet');
                return;
            }
            
            console.log('Updating map...');
            
            const startDate = document.getElementById('mapStartDate').value;
            const endDate = document.getElementById('mapEndDate').value;
            
            let mapOrders = allOrders.filter(order => {
                let matchesStartDate = true;
                let matchesEndDate = true;
                
                if (startDate && order.date) {
                    matchesStartDate = order.date >= startDate;
                }
                if (endDate && order.date) {
                    matchesEndDate = order.date <= endDate;
                }
                
                return matchesStartDate && matchesEndDate && order.address && order.address.trim();
            });
            
            console.log('Orders to plot:', mapOrders.length);
            
            clearMarkers();
            
            const addressGroups = {};
            let pickupCount = 0;
            
            mapOrders.forEach(order => {
                const cleanedAddr = cleanAddress(order.address);
                if (cleanedAddr.includes('74 5th Ave')) {
                    pickupCount++;
                }
                
                if (!addressGroups[cleanedAddr]) {
                    addressGroups[cleanedAddr] = [];
                }
                addressGroups[cleanedAddr].push(order);
            });
            
            document.getElementById('mapOrdersCount').textContent = mapOrders.length;
            document.getElementById('mapUniqueAddresses').textContent = Object.keys(addressGroups).length;
            document.getElementById('mapPickupsCount').textContent = pickupCount;
            
            for (const [address, orders] of Object.entries(addressGroups)) {
                try {
                    const location = await geocodeAddress(address);
                    if (location) {
                        const isPickup = address.includes('74 5th Ave');
                        const marker = new google.maps.Marker({
                            position: { lat: location.lat, lng: location.lng },
                            map: map,
                            title: `${orders.length} order(s) at ${location.formattedAddress}`,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: Math.max(6, Math.min(20, 6 + orders.length * 2)),
                                fillColor: isPickup ? '#10b981' : '#7877c6',
                                fillOpacity: 0.8,
                                strokeColor: '#ffffff',
                                strokeWeight: 2
                            }
                        });
                        
                        const infoContent = `
                            <div style="color: #333; font-family: 'Montserrat', sans-serif; max-width: 300px;">
                                <h3 style="margin: 0 0 10px 0; color: #7877c6; font-size: 16px;">
                                    ${isPickup ? 'üì¶ Pickup Location' : 'üìç Delivery Location'}
                                </h3>
                                <p style="margin: 0 0 10px 0; font-weight: 500;">${location.formattedAddress}</p>
                                <p style="margin: 0 0 15px 0; color: #666;"><strong>${orders.length}</strong> order(s)</p>
                                <div style="max-height: 200px; overflow-y: auto;">
                                    ${orders.slice(0, 10).map(order => `
                                        <div style="border-bottom: 1px solid #eee; padding: 8px 0; font-size: 14px;">
                                            <div style="font-weight: 500; color: #333;">${order.company}</div>
                                            <div style="color: #666; font-size: 12px;">
                                                ${order.date} | ${order.time} | ${order.guestsRaw} guests
                                            </div>
                                            <div style="color: #7877c6; font-size: 12px;">${order.platform}</div>
                                            ${order.driver ? `<div style="color: #555; font-size: 12px; font-weight: 500;">Driver: ${order.driver}</div>` : ''}
                                        </div>
                                    `).join('')}
                                    ${orders.length > 10 ? `<div style="text-align: center; color: #666; font-size: 12px; padding: 5px;">... and ${orders.length - 10} more</div>` : ''}
                                </div>
                            </div>
                        `;
                        
                        const infoWindow = new google.maps.InfoWindow({
                            content: infoContent
                        });
                        
                        marker.addListener('click', () => {
                            markers.forEach(m => {
                                if (m.infoWindow) m.infoWindow.close();
                            });
                            infoWindow.open(map, marker);
                        });
                        
                        marker.infoWindow = infoWindow;
                        markers.push(marker);
                    }
                } catch (error) {
                    console.warn('Failed to create marker for address:', address, error);
                }
            }
            
            console.log('Created', markers.length, 'markers');
        }

        function showTodaysOrdersOnMap() {
            const today = getTodaysDate();
            document.getElementById('mapStartDate').value = today;
            document.getElementById('mapEndDate').value = today;
            updateMap();
        }

        function setMapDateRange(range) {
            const endDate = new Date();
            const startDate = new Date();
            
            if (range === '7days') {
                startDate.setDate(endDate.getDate() - 7);
            } else if (range === '30days') {
                startDate.setDate(endDate.getDate() - 30);
            }
            
            document.getElementById('mapStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('mapEndDate').value = endDate.toISOString().split('T')[0];
            
            updateMap();
        }

        // Initialize and auto-connect
        document.addEventListener('DOMContentLoaded', function() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - 30);
            
            document.getElementById('analyticsStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('analyticsEndDate').value = endDate.toISOString().split('T')[0];
            
            autoConnect();
        });
    </script>
</body>
</html>